GROUP=$1
PROJECT=$2
JENKINSURL=http://jenkins.egovernments.org
JENKINSUSER=developer
PASSWORD=developer@123
TOKEN=iamadev2017

echo "Deploying $PROJECT from group $GROUP. Do you want to continue (y/n)?"
read confirm

if [ $confirm = "n" ]
then
  echo "Cancelling..."
else
  #get csrf token
  CRUMB=$(curl -s -u$JENKINSUSER:$PASSWORD $JENKINSURL/crumbIssuer/api/json | jq -r '.crumb')

  #trigger build
  curl -XPOST -u$JENKINSUSER:$PASSWORD -H "Jenkins-Crumb:$CRUMB" "$JENKINSURL/job/$GROUP/job/$PROJECT/build?delay=0&token=$TOKEN&cause=triggered+via+script"
  echo "Triggering build.."
  BUILD_IN_PROGRESS=0
  while [ $BUILD_IN_PROGRESS -eq 0 ]
  do
     sleep 10
     # Grep will return 0 while the build is running:
     curl -s -XGET -u $JENKINSUSER:$PASSWORD $JENKINSURL/job/$GROUP/job/$PROJECT/lastBuild/api/json | grep result\":null > /dev/null
     BUILD_IN_PROGRESS=$?
     #wait for build run to complete
     curl -s -XGET -u$JENKINSUSER:$PASSWORD $JENKINSURL/job/$GROUP/job/$PROJECT/lastBuild/api/json | jq '.result'
     echo "Waiting for completion..."
  done

  #get new image tag
  NEW_IMAGE_HASH=$(curl -s -XGET -u$JENKINSUSER:$PASSWORD $JENKINSURL/job/$GROUP/job/$PROJECT/lastBuild/consoleText | grep "docker push" | head -1 | cut -d: -f2)

  if [ -z "$NEW_IMAGE_HASH" ]
  then
     echo "Image tag not present..exiting"
  else
     #trigger dev deployment
     BUILDQUEUELOCATION=$(curl -I -s -XPOST -u $JENKINSUSER:$PASSWORD -H "Jenkins-Crumb:$CRUMB" "$JENKINSURL/job/deployments/job/deploy-to-dev/buildWithParameters?token=$TOKEN&service=$PROJECT&tag=$NEW_IMAGE_HASH&cause=triggered+via+script" | grep "Location:" | cut -d' ' -f2)
     BUILD_IN_PROGRESS=0
     echo "Triggering deployment to dev..."
     while [ $BUILD_IN_PROGRESS -eq 0 ]
     do
       sleep 10
       # Grep will return 0 while the build is running:
       NEWBUILDURL=$(curl -s -u $JENKINSUSER:$PASSWORD ${BUILDQUEUELOCATION:0:-1}api/json | jq -r '.executable.url')
       curl -s -XGET -u $JENKINSUSER:$PASSWORD ${NEWBUILDURL}api/json | grep result\":null > /dev/null
       BUILD_IN_PROGRESS=$?
       #wait for build run to complete
       curl -s -XGET -u$JENKINSUSER:$PASSWORD ${NEWBUILDURL}api/json | jq '.result'
       echo "Waiting for deployment completion..."
     done
     echo "Deployment complete"
  fi
fi





